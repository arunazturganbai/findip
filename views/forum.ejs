<%- include('partials/navbar'); -%>



<link rel="icon" href="../public/logo-transparent.png" type="image/x-icon">
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 0;
    background-color: #ecebd7;
}
  .main-content {
    padding: 20px 50px;
    font-family: 'Segoe UI', sans-serif;
  }
  
  .auth-links {
    text-align: right;
    margin: 10px 20px;
  }
    .auth-linkss {
    display: flex;
  justify-content: space-between;
  align-items: center;
  margin: 10px 20px;
  }

  .auth-linkss a, .auth-links span {
    margin-left: 10px;
    text-decoration: none;
    color: #2c3e50;
    font-weight: 500;
  }

  .comment {
    background-color: #fff;
    border-radius: 12px;
    padding: 15px 20px;
    margin-bottom: 15px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
  }

  .comment .author {
    font-weight: bold;
    color: #3498db;
    margin-bottom: 8px;
  }

  .comment .text {
    font-size: 15px;
    color: #333;
  }

  .comment button {
    background: #e74c3c;
    border: none;
    color: white;
    padding: 6px 12px;
    border-radius: 6px;
    cursor: pointer;
    float: right;
  }

  #comment-form {
    background: #fff;
    padding: 15px;
    border-radius: 12px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    margin-top: 20px;
  }

  #comment-form textarea {
    width: 100%;
    height: 80px;
    resize: none;
    padding: 10px;
    font-size: 15px;
    margin-bottom: 10px;
    border-radius: 8px;
    border: 1px solid #ccc;
  }

  #comment-form button {
    background-color: #3498db;
    color: white;
    border: none;
    padding: 10px 20px;
    font-weight: bold;
    border-radius: 8px;
    cursor: pointer;
  }
</style>
<body>
<div class="auth-linkss">
  <% if (user) { %>
    <span>“ö–æ—à –∫–µ–ª–¥—ñ“£—ñ–∑, <%= user.email %></span>
    <a href="/logout">–®—ã“ì—É</a>
  <% } else { %>
    <a href="/login">–ö—ñ—Ä—É</a>
    <a href="/signup">–¢—ñ—Ä–∫–µ–ª—É</a>
  <% } %>
</div>

<div class="main-content">
  <section id="forum"></section>

  <% if (user) { %>
    <form id="comment-form">
      <textarea id="comment" placeholder="–ü—ñ–∫—ñ—Ä “õ–∞–ª–¥—ã—Ä—ã“£—ã–∑..." required></textarea>
      <button type="submit">–ñ—ñ–±–µ—Ä—É</button>
    </form>
  <% } else { %>
    <p style="text-align: center;">–ü—ñ–∫—ñ—Ä “õ–∞–ª–¥—ã—Ä—É “Ø—à—ñ–Ω <a href="/login">–∫—ñ—Ä—ñ“£—ñ–∑</a>.</p>
  <% } %>
</div>

<script>
  window.currentUserId = '<%= user ? user._id : "" %>';
</script>

<script>
document.getElementById('comment-form')?.addEventListener('submit', async (e) => {
  e.preventDefault();
  const text = document.getElementById('comment').value;

  const res = await fetch('/comments', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ text })
  });

  if (res.ok) {
    document.getElementById('comment').value = '';
    loadComments();
  } else {
    alert('“ö–∞—Ç–µ: –ø—ñ–∫—ñ—Ä–¥—ñ –∂—ñ–±–µ—Ä—É –º“Ø–º–∫—ñ–Ω –±–æ–ª–º–∞–¥—ã.');
  }
});

async function loadComments() {
  const res = await fetch('/comments');
  if (!res.ok) return console.error('“ö–∞—Ç–µ –∂“Ø–∫—Ç–µ—É –∫–µ–∑—ñ–Ω–¥–µ');

  const comments = await res.json();
  const forum = document.getElementById('forum');
  forum.innerHTML = '';

  comments.forEach(comment => {
    const div = document.createElement('div');
    div.className = 'comment';

    // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
    const userInfo = document.createElement('div');
    userInfo.style.display = 'flex';
    userInfo.style.alignItems = 'center';
    userInfo.style.marginBottom = '10px';

    // –î–æ–±–∞–≤–ª—è–µ–º –∏–∫–æ–Ω–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const userIcon = document.createElement('div');
    userIcon.innerHTML = 'üë§'; // –∏–ª–∏ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å <img> –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω–æ–π –∏–∫–æ–Ω–∫–∏
    userIcon.style.marginRight = '10px';
    userIcon.style.fontSize = '20px';

    // –î–æ–±–∞–≤–ª—è–µ–º –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const author = document.createElement('div');
    author.textContent = comment.userId.email; 
    author.style.fontWeight = 'bold';
    author.style.color = '#3498db';

    // –°–æ–±–∏—Ä–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
    userInfo.appendChild(userIcon);
    userInfo.appendChild(author);

    // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
    const text = document.createElement('div');
    text.className = 'text';
    text.textContent = comment.text;
    text.style.marginTop = '5px';

    // –°–æ–±–∏—Ä–∞–µ–º –≤–µ—Å—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
    div.appendChild(userInfo);
    div.appendChild(text);

    if (comment.userId === window.currentUserId) {
      const delBtn = document.createElement('button');
      delBtn.textContent = 'üóëÔ∏è ”®—à—ñ—Ä—É';
      delBtn.onclick = async () => {
        const confirmed = confirm('–°—ñ–∑ –±“±–ª –ø—ñ–∫—ñ—Ä–¥—ñ ”©—à—ñ—Ä–≥—ñ“£—ñ–∑ –∫–µ–ª–µ –º–µ?');
        if (!confirmed) return;

        const delRes = await fetch(`/comments/${comment._id}`, {
          method: 'DELETE'
        });

        if (delRes.ok) loadComments();
        else alert('“ö–∞—Ç–µ: –ø—ñ–∫—ñ—Ä–¥—ñ ”©—à—ñ—Ä—É –º“Ø–º–∫—ñ–Ω –±–æ–ª–º–∞–¥—ã.');
      };
      div.appendChild(delBtn);
    }

    forum.appendChild(div);
  });
}

loadComments();
</script>
</body>

<!--
<script>
async function loadComments() {
  const res = await fetch('/comments');
  if (!res.ok) return console.error('“ö–∞—Ç–µ –∂“Ø–∫—Ç–µ—É –∫–µ–∑—ñ–Ω–¥–µ');

  const comments = await res.json();
  const forum = document.getElementById('forum');
  forum.innerHTML = '';

  comments.forEach(comment => {
    const div = document.createElement('div');
    div.className = 'comment';

    // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
    const userInfo = document.createElement('div');
    userInfo.style.display = 'flex';
    userInfo.style.alignItems = 'center';
    userInfo.style.marginBottom = '10px';

    // –î–æ–±–∞–≤–ª—è–µ–º –∏–∫–æ–Ω–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const userIcon = document.createElement('div');
    userIcon.innerHTML = 'üë§'; // –∏–ª–∏ –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å <img> –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω–æ–π –∏–∫–æ–Ω–∫–∏
    userIcon.style.marginRight = '10px';
    userIcon.style.fontSize = '20px';

    // –î–æ–±–∞–≤–ª—è–µ–º –∏–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const author = document.createElement('div');
    author.className = 'author';
    author.textContent = comment.userEmail || comment.userName || '–ê–Ω–æ–Ω–∏–º';
    author.style.fontWeight = 'bold';
    author.style.color = '#3498db';

    // –°–æ–±–∏—Ä–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ
    userInfo.appendChild(userIcon);
    userInfo.appendChild(author);

    // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—Å—Ç –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
    const text = document.createElement('div');
    text.className = 'text';
    text.textContent = comment.text;
    text.style.marginTop = '5px';

    // –°–æ–±–∏—Ä–∞–µ–º –≤–µ—Å—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π
    div.appendChild(userInfo);
    div.appendChild(text);

    // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É —É–¥–∞–ª–µ–Ω–∏—è –¥–ª—è —Å–≤–æ–∏—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
    if (comment.userId === window.currentUserId) {
      const delBtn = document.createElement('button');
      delBtn.textContent = 'üóëÔ∏è ”®—à—ñ—Ä—É';
      delBtn.style.float = 'right';
      delBtn.style.marginTop = '-25px';
      delBtn.onclick = async () => {
        const confirmed = confirm('–°—ñ–∑ –±“±–ª –ø—ñ–∫—ñ—Ä–¥—ñ ”©—à—ñ—Ä–≥—ñ“£—ñ–∑ –∫–µ–ª–µ –º–µ?');
        if (!confirmed) return;

        const delRes = await fetch(`/comments/${comment._id}`, {
          method: 'DELETE'
        });

        if (delRes.ok) loadComments();
        else alert('“ö–∞—Ç–µ: –ø—ñ–∫—ñ—Ä–¥—ñ ”©—à—ñ—Ä—É –º“Ø–º–∫—ñ–Ω –±–æ–ª–º–∞–¥—ã.');
      };
      div.appendChild(delBtn);
    }

    forum.appendChild(div);
  });
}

loadComments();
</script>
-->